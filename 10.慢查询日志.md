# 慢查询日志

- MySQL 的慢查询日志，是 MySQL 提供的一种日志记录，它用来记录在 MySQL 中响应时间超过阈值的语句，具体值
  运行时间超过 long_query_time 值的 SQL, 则会被记录到慢查询日志中。
- 具体指的是运行时间超过 long_query_time 值的 SQL, 则会被记录到慢查询日志中。long_query_time 的默认值为 10s.
  意思是运行 10s 以上的语句。
- 由它来查看哪些 SQL 超出了我们的最大忍耐时间值，比如一条 sql 执行超过 5s,就算慢 SQL,希望能收集超过 5s 的慢 SQL.再结合 explain
  进行全面分析。

## 如何设置查看

1. 是否开启

- 默认情况下，MySQL 数据库灭有开启慢查询日志。需要手动设置。
- 一般不建议启动该参数，因为开启慢查询日志会多少带来一定的性能影响。
- 慢查询日志的文件默认存放在 MySQL 的数据目录下，文件名为 slow_query.log.

```sql
SHOW VARIABLES LIKE '%slow_query_log%';
-- 使用 set global slow_query_log=1; 可以临时开启慢查询日志，只对当前数据库生效
-- 如果MySQL重启后，则会失效；
set global slow_query_log=1;
```

2. 开启后，什么样的 SQL 才会记录到慢查询日志？

```sql
-- 查看当前多少秒算慢
SHOW VARIABLES LIKE '%long_query_time%';

-- 设置多少秒算慢
SET GLOBAL long_query_time = 5;

-- 为什么设置后看不出变化？
-- > 需要重新连接或新开一个会话才能看到修改值；
SHOW GLOBAL VARIABLES LIKE '%long_query_time%';

-- 查询有多少条慢查询
SHOW GLOBAL STATUS LIKE '%slow_queries%';
```

## 日志分析工具 mysqldumpslow

- 在生产环境中，如果要手工分析日志，查找，分析 SQL,显然是个体力活。MySQL 提供了一个日志分析工具 mysqldumpslow.

```sql
-- 得到返回记录集最多的10个SQL
mysqldumpslow -s r -t 10 /var/lib/mysql/adllll-slow.log

-- 得到执行次数最多的10个SQL
mysqldumpslow -s c -t 10 /var/lib/mysql/adllll-slow.log

-- 得到按照时间排序的前10条里面含有左连接的查询语句
mysqldumpslow -s t -t 10 -g "LEFT JOIN" /var/lib/mysql/adllll-slow.log

-- 另外建议在使用这些命令时，结合 | 和 more 使用，否则有可能出现爆屏情况
mysqldumpslow -s r -t 10 /var/lib/mysql/adllll-slow.log | more
```
