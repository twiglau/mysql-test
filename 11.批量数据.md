# 批量数据处理

```sql
CREATE TABLE dept(
id INT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
deptno MEDIUMINT UNSIGNED NOT NULL DEFAULT 0,
dname VARCHAR(20) NOT NULL DEFAULT ''
loc VARCHAR(13) NOT NULL DEFAULT ''
)ENGINE=INNODB DEFAULT CHARSET=GBK;

```

```sql
-- 建表emp
CREATE TABLE emp(
id INT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
empno MEDIUMINT UNSIGNED NOT NULL DEFAULT 0,
ename VARCHAR(20) NOT NULL DEFAULT '',
job VARCHAR(9) NOT NULL DEFAULT '', /*工作 */
mgr MEDIUMINT UNSIGNED NOT NULL DEFAULT 0, /*上级编号 */
hiredate DATE NOT NULL, /*雇佣日期 */
sal DECIMAL(7,2) NOT NULL, /*薪水 */
comm DECIMAL(7,2) NOT NULL, /*红利 */
deptno MEDIUMINT UNSIGNED NOT NULL DEFAULT 0 /*部门编号 */
)ENGINE=INNODB DEFAULT CHARSET=GBK;

```

## 设置参数 log_bin_trust_function_creators

- 创建函数时，假如报错： This function has none of DETERMINISTIC, NO SQL, or READS SQL DATA in its declaration and binary logging is enabled (you _might_ want to use the less safe log_bin_trust_function_creators variable)
  > 由于开启慢查询日志，开启了 bin-log. 我们就必须为我们的 function 指定一个参数

```sql
SHOW VARIABLES LIKE 'log_bin_trust_function_creators';
SET GLOBAL log_bin_trust_function_creators = 1;
```

- 添加了参数以后，如果 mysql 重启，上述参数又会消失， 永久的方法：

```lua
# linux下
/etc/mycnf 下添加
log_bin_trust_function_creators = 1

```

## 创建函数，保证每条数据都不同

- 随机产生字符串

```sql
DELIMITER $$
CREATE FUNCTION rand_string(n INT) RETURNS VARCHAR(255)
BEGIN
    DECLARE chars_str VARCHAR(100) DEFAULT 'abcdefghijkimnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ';
    DECLARE return_str VARCHAR(255) DEFAULT '';
    DECLARE i INT DEFAULT 0;
    WHILE i < n DO
    SET return_str=CONCAT(return_str,SUBSTRING(chars_str,FLOOR(1+RAND()*52), 1));
    SET i = i + 1;
    END WHILE;
    RETURN return_str;
END $$
```

- 随机产生部门编号

```sql
-- 用于随机产生部门编号
DELIMITER $$
CREATE FUNCTION rand_num()
RETURNS INT(5)
BEGIN
    DECLARE i INT DEFAULT 0;
    SET i = FLOOR(100+RAND()*10);
    RETURN i;
END $$
```

- 删除创建的函数

```sql
DROP FUNCTION rand_string;
DROP FUNCTION rand_num;
```

## 创建存储过程，批量插入数据

- 创建往 emp 表中插入数据的存储过程

```sql
DELIMITER $$
CREATE PROCEDURE insert_emp(IN START INT(10),IN max_num INT(10))
BEGIN
DECLARE i INT DEFAULT 0;
-- set autocommit =0 把autocommit设置成0
SET autocommit = 0;
REPEAT
SET i = i + 1;
INSERT INTO emp(empno,ename,job,mgr,hiredate,sal,comm,deptno) VALUES((START+i),rand_string(6), 'SALESMAN',0001,CURDATE(),2000,400,rand_num());
UNTIL i = max_num
END REPEAT;
COMMIT;
END $$
```

- 创建往 dept 表中插入数据的存储过程

```sql
DELIMITER $$
CREATE PROCEDURE insert_dept(IN START INT(10), IN max_num INT(10))
BEGIN
DECLARE i INT DEFAULT 0;
SET autocommit = 0;
REPEAT
SET i = i + 1;
INSERT INTO dept(deptno dname,loc) VALUES((START+i),rand_string(10),rand_string(8));
UNTIL i = max_num
END REPEAT;
COMMIT;
END $$
```

## 调用存储过程

- dept 表插入数据

```sql
DELIMITER;
CALL insert_dept(100,10);
```

- emp 表插入数据

```sql
DELIMITER;
CALL insert_emp(100001,500000);
```
